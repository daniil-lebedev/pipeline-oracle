name: Pipeline Oracle

on:
  workflow_run:
    workflows: [ "CI Pipeline" ]  # Track this specific workflow
    types:
      - completed

jobs:
  failure-analysis:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}  # Only run if the tracked workflow failed
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fetch logs from last failed workflow
        run: |
          echo "[INFO] Fetching last failed workflow..."
          # Get the last failed workflow run ID that is not this workflow
          RUN_ID=$(gh run list --limit 5 --json databaseId,name,conclusion \
            --jq '[.[] | select(.conclusion == "failure" and .name != "On Failure Log Analysis")][0].databaseId')
          if [ -z "$RUN_ID" ]; then
            echo "[ERROR] No failed workflows found. Exiting." >&2
            exit 1
          fi
          echo "[INFO] Last failed workflow ID: $RUN_ID"
          mkdir -p logs
          echo "[INFO] Fetching logs for run $RUN_ID..."
          gh run view "$RUN_ID" --log > logs/full_log.txt || echo "[WARNING] Could not fetch logs"
          echo "[INFO] Log file (first 20 lines):"
          head -20 logs/full_log.txt || echo "[WARNING] Log file is empty"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Set up Python and install dependencies
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run AI Analysis on Execution Logs
        run: python analyze_execution.py
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Upload analysis report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: failure-analysis-report
          path: |
            analysis_report.md
            logs/full_log.txt
          if-no-files-found: warn
